<html>
  <head>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
  </head>
  <body>
    <script>
      var ws = new WebSocket("ws://" + document.domain + ":5000/ws"),
          name = "";

      function joinGame() {
        var text, button;

        function sendName() {
          name = text.val();
          if (name) {
            $("#game").empty();
            ws.send(name);
          }
        }

        text = $('<input name="playerName" type="text" />');
        button = $('<button name="playerJoin" type="button">Join</button>');
        button.click(sendName);
        $("#game").append(text).append(button);
      }

      ws.onmessage = function(message) {
        message = message.data;
        console.log("Message recieved: " + message);
        message = JSON.parse(message);
        if (message.type === 'join') {
          newHand(message.hand);
        } else if (message.type === 'round_start') {
          startRound(message.category, message.judge);
        } else if (message.type === 'draw') {
          addCard(message.card);
        } else if (message.type === 'display') {
          displayCard(message.cards);
        } else {
          console.log('Unknown message type: ' + message.type);
        }
      }

      ws.onclose = function() {
        console.log("Server disconnected");
        $("#game").empty().append('<h1>Server disconnected</h1>');
      }

      function makeCardButton(card) {
        return '<button class="card" type="button">' + card + '</button>';
      }

      function newHand(cards) {
        var i, hand;
        hand = $('<div class="hand" />');
        hand.append('<h1>Your hand:</h1>');
        for (i = 0; i < cards.length; ++i) {
          hand.append(makeCardButton(cards[i]));
        }
        $("#game").append(hand);
      }

      function startRound(category, judge) {
        var round, submitted = false;
        round = $('<div class="round" />');
        round.append('<h3>Judge: ' + judge + '</h3>');
        round.append('<h2>Category: ' + category + '</h2>');
        $("#game").append(round);

        if (judge !== name) {
          $(".hand").children().click(function() {
            var button = $(this);
            if (!submitted) {
              submitted = true;
              submitCard(button.text());
              button.remove();
            }
          });
        }
      }

      function addCard(card) {
        $(".hand").append(makeCardButton(card));
      }

      function submitCard(card) {
        ws.send(card);
        $(".round").append('<h2>You submitted: ' + card + '</h2>');
      }

      function displayCards(cards) {
        var submitted, i;
        submitted = $('<div class="submitted" />');
        for (i = 0; i < cards.length; ++i) {
          submitted.append(cards[i]);
        }
      }

      window.onload = joinGame;
    </script>
    <div id="game">
    </div>
  </body>
</html>
